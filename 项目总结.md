一，项目搭建

## 1.创建父类项目mingrui-shop-parent

删除项目下的src目录

在pom.xml引入依赖

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
		http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shop-parent</artifactId>
    <version>1.0-SNAPSHOT</version>
    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <properties>
        <!--项目构建编码-->
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF8</project.reporting.outputEncoding>
        <!--声明JDK版本-->
        <java.version>1.8</java.version>
        <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
        <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
    </properties>
    <!--boot 版本-->
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.1.RELEASE</version>
        <!--始终从仓库中获取，不从本地路径获取-->
        <relativePath />
    </parent>
    <dependencies>
        <!-- 集成commons工具类 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
        <!-- 集成lombok 框架 -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!--junit测试-->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <!-- SpringBoot整合eureka客户端 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!--boot 测试模块-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
	</dependencies>
    <!-- 项目依赖,子级模块可以继承依赖-->
    <dependencyManagement>
        <dependencies>
        <!--cloud 依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${mr.spring.cloud.version}</version>
            <type>pom</type>
            <!--解决maven单继承的问题-->
            <scope>import</scope>
        </dependency>
        </dependencies>
    </dependencyManagement>
    <!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
    <repositories>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/libs-milestone</url>
            <snapshots>
            <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>
</project>

```

## 2.创建基于父类的服务mingrui-shop-basics

删除项目下的src目录

在pom.xml中修改打包方式

```
    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
```

## 3.创建公共工具mingrui-shop-commons

删除项目下的src目录

在pom.xl中修改打包方式

```
    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
```

## 4.创建服务实现工程mingrui-shop-service

删除项目下的src目录

在pom.xml引入依赖

```
    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
    </dependencies>
```

## 5.创建服务接口工程mingrui-shop-api

删除项目下的src目录

在pom.xml引入依赖

```
	<!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
    </dependencies>
```

## 6.创建eureka服务中心

在mingrui-shop-basics中创建mingrui-shop-basics-eureka

注意:不是父类项目不用删除项目下的src目录!!!!

在pom.xml中引入依赖

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
		http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mingrui-shop-basics</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
	<modelVersion>4.0.0</modelVersion>
	<artifactId>mingrui-shop-basic-eureka-server</artifactId>
    <dependencies>
        <!--eureka 服务依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
    </dependencies>
</project>

```

### 在resources创建配置文件application.yml

```
server:
   port: 8761
spring:
   application:
       name: eureka-server
eureka:
  client:
    service-url:
       defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
    register-with-eureka: false
    fetch-registry: false
  instance:
    hostname: localhost
    lease-renewal-interval-in-seconds: 1
    lease-expiration-duration-in-seconds: 2
  server:
    enable-self-preservation: false
```

### 创建启动类

```
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

/**
 * @ClassName RunEurekaServerApplication
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/23
 * @Version V1.0
 **/
@SpringBootApplication
@EnableEurekaServer
public class RunEurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunEurekaServerApplication.class);
    }
}
```

# 二，商品分类管理

## 在本地添加域名

 在本地C:/Windows/System32/drivers/etc/hosts

```
    127.0.0.1 api.mrshop.com  #我们的网关Zuul
    127.0.0.1 manage.mrshop.com #我们后台系统地址
```

## 安装nginx-1.16.1-- **使用**

nginx可以通过命令行来启动，操作命令：

启动： start nginx.exe

停止： nginx.exe -s stop

重新加载： nginx.exe -s reload



在nginx/conf/nginx.conf文件夹添加

```
server {
    listen 80;
    server_name manage.mrshop.com;
    
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    location / {
        proxy_pass http://127.0.0.1:9001;
        proxy_connect_timeout 600;
        proxy_read_timeout 600;
    }
}
server {
    listen 80;
    server_name api.mrshop.com;
    
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    location / {
        proxy_pass http://127.0.0.1:8088;
        proxy_connect_timeout 600;
        proxy_read_timeout 600;
    }
}
```

## 商品分类管理(查询)

### 在mingrui-shop-commons下创建子项目 mingrui-shop-commons-core

在pom.xml添加依赖

```
    <dependencies>
    	<!--处理json与各种数据类型或文档类型的转换-->
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>2.8.5</version>
        </dependency>
        <!--json对象序列化和反序列化的支持-->
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-core-lgpl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <dependency>
        	<groupId>org.codehaus.jackson</groupId>
        	<artifactId>jackson-mapper-lgpl</artifactId>
			<version>1.9.13</version>
        </dependency>
        <!--java对象和json对象之间的转换-->
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-core-asl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-mapper-asl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <!--alibaba的json处理工具-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.62</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.11.2</version>
        </dependency>
    </dependencies>
```

### 创建工具包 com.baidu.shop.utils

#### 创建工具类JSONUtil

```
package com.baidu.shop.utils;

import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;

import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @ClassName JSONUtil
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/23
 * @Version V1.0
 **/
public class JSONUtil {
    private static Gson gson = null;

    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }

    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }

    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }

    public static <T> T toBean(String json, Class<T> clz) {

        return gson.fromJson(json, clz);
    }

    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new TypeToken<Map<String, JsonObject>>() {
        }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }

    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String, Object>>() {
        }.getType());
        return map;
    }

    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }

    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }

    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }

    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     *            键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }

    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }

        }
    }

    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }

    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }

    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }

    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }

    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }

    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());

            }

        }
    }

    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }

    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }

        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];

        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }

    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }
}


```

### 创建异常包 com.baidu.shop.status

#### 创建HTTPStatus

```
package com.baidu.shop.status;

/**
 * @ClassName HTTPStatus
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/23
 * @Version V1.0
 **/
public class HTTPStatus {
    public static final int OK = 200;//成功
    public static final int ERROR = 500;//失败
    public static final int OPERATION_ERROR = 5001;
    public static final int PARAMS_VALIDATE_ERROR = 5002;//参数校验失败
}
```

### 创建包 com.baidu.shop.base

```
package com.baidu.shop.base;

import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.HashMap;

/**
 * @ClassName Result
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Data
@NoArgsConstructor
public class Result<T> {

    private Integer code;//返回码

    private String message;//返回消息

    private T data;//返回数据

    public Result(Integer code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }
}
```

#### BaseApiService

封装 Result

```
package com.baidu.shop.base;

import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.JSONUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * @ClassName BaseApiService
 * @Description: 接口的实现类继承此类
 * @Author zhengzhenbo
 * @Date 2020/8/17
 * @Version V1.0
 **/
@Data
@Component
@Slf4j
public class BaseApiService<T> {
    public Result<T> setResultError(Integer code, String msg) {
        return setResult(code, msg, null);
    }
    // 返回错误，可以传msg
    public Result<T> setResultError(String msg) {
        return setResult(HTTPStatus.ERROR, msg, null);
    }
    // 返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess() {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess(String msg) {
        return setResult(HTTPStatus.OK, msg, null);
    }
    // 通用封装
    public Result<T> setResult(Integer code, String msg, T data) {
        log.info(String.format("{code : %s , msg : %s , data : %s}",code,msg,JSONUtil.toJsonString(data)));
        return new Result<T>(code, msg, data);
    }
}

```

### 创建service-api工程 创建mingrui-shop-service-api子项目

在 pom.xml中引入依赖

```
     <dependencies>
     	<!-- SpringBoot-整合Web组件 -->
     	<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
		<!--Entity 中的@Table 和@Id需要次注解-->
        <dependency>
            <groupId>javax.persistence</groupId>
            <artifactId>persistence-api</artifactId>
            <version>1.0.2</version>
        </dependency>
		<!--2.3版本之后web删除了验证插件-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <!--引入common工程代码-->
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-common-core</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
     </dependencies>
```

### 在mingrui-shop-service-api项目下新建mingrui-shopservice-api-xxx项目

在pom.xml引入依赖

```
    <dependencies>
        <!--帮助开发人员快速生成API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger2</artifactId>
            <version>2.9.2</version>
        </dependency>
        <!--提供可视化的API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger-ui</artifactId>
            <version>2.9.2</version>
        </dependency>
    </dependencies>
```

#### 创建实体包com.baidu.shop.entity

##### 创建分类查询实体类 CategoryEntity

```
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * @ClassName CategoryEntity
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/22
 * @Version V1.0
 **/
@ApiModel(value = "分类实体类")//swagger的注解 : 声明模型
@Data
@Table(name = "tb_category") //java 的实体类和数据库中的表做映射
public class CategoryEntity {

    @Id //声明主键
    @ApiModelProperty(value = "类目id",example = "1") //所有的数字类型在写swagger的时候需要加example="默认值",测试接口
    @NotNull(message = "id不能为空", groups = {MingruiOperation.Update.class})
    private Integer id;//如果没有@Column 默认使用entity的属性名和 数据库表的字段名做映射

    @ApiModelProperty(value = "类目名称")
    @NotEmpty(message = "分类名称不能为空", groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父类目id,顶级类目填0",example = "1")
    @NotNull(message = "父级分类不能为null",groups = {MingruiOperation.Add.class})
    private Integer parentId;//会自动将驼峰转换为 _x的形式

    @ApiModelProperty(value = "是否是父级节点",example = "1")
    @NotNull(message = "是否为父级节点不能为null",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value = "排序",example = "1")
    @NotNull(message = "排序字段不能为null",groups = {MingruiOperation.Add.class})
    private Integer sort;
}
```

##### 配置swagger2的配置

创建com.baidu.shop.config包

创建类MrSwagger2Config

```
package com.baidu.shop.config;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
/**
 * @ClassName MrSwagger2Config
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/8/17
 * @Version V1.0
 **/
@Configuration
@EnableSwagger2
public class MrSwagger2Config {
    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }
    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
//标题
                .title("明瑞SWAGGER2标题")
//条款地址
                .termsOfServiceUrl("http://www.baidu.com")
//联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new
                        Contact("shenyaqi","baidu.com","shenyaqiii@163.com"))
//版本
                .version("v1.0")
//项目描述
                .description("描述")
//创建API基本信息
                .build();
    }
}

```

#### 定义商品分类接口

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import javafx.scene.chart.ValueAxis;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @ClassName CategoryService
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Api(tags = "商品分类接口")
public interface CategoryService {

    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);
}
```

### service工程

#### 在mingrui-shop-service的pom.xml中引入依赖

```
    <dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--mysql数据库连接-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope><!--项目运行阶段使用-->
        </dependency>
        <!--通用mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
            <version>2.1.5</version>
        </dependency>
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-service-api-xxx</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
```

###  在mingrui-shop-service工程下新建mingrui-shop-service-xxx工程

创建application,yml

```
server:
  port: 8100

spring:
  application:
    name: xxx-server
    # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://localhost:3306/2005?useUnicode=true&characterEncoding=utf8

    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000

# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
  #日志设置
logging:
  level:
    # 打印与我们程序相关的日志信息
    com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

### 新建包com.baidu

#### 创建启动类

```
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import tk.mybatis.spring.annotation.MapperScan;
/**
* @ClassName RunXXXApplication
* @Description: TODO
* @Author zhengzhenbo
* @Date 2020/8/17
* @Version V1.0
**/
@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")
public class RunXXXApplication {
    public static void main(String[] args) {
    	SpringApplication.run(RunXXXApplication.class);
    }
}
```

#### 在com.baidu包下创建shop.mapper

创建mapper接口

```
import com.baidu.shop.entity.CategoryEntity;
import tk.mybatis.mapper.common.Mapper;
/**
* @ClassName CategoryMapper
* @Description: TODO
* @Author zhengzhenbo
* @Date 2020/8/17
* @Version V1.0
**/
public interface CategoryMapper extends Mapper<CategoryEntity> {
}

```

#### 在com.baidu下新建包shop.service.impl

创建实现类CategoryServiceImpl

```
package com.baidu.shop.service.impl;

import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.service.CategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import java.util.List;

/**
 * @ClassName CategoryServiceImpl
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/22
 * @Version V1.0
 **/
@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {
    @Resource
    private CategoryMapper categoryMapper;


    @Override//查询
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
        CategoryEntity categoryEntity = new CategoryEntity();
        categoryEntity.setParentId(pid);
        List<CategoryEntity>list = categoryMapper.select(categoryEntity);
        return this.setResultSuccess(list);
    }
}
```

### 网关服务

#### 在mingrui-shop-basic项目下新建mingrui-shop-basic-zuul-server

##### 在pom.xml中引入依赖

```
    <dependencies>
        <!-- zuul -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
        </dependency>
    </dependencies>
```

#####  创建application.yml

```
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server
#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

#### 在mingrui-shop-basic-zuul-server先新建包com.baidu

新建启动类

```
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;
/**
* @ClassName RunZuulServerApplication
* @Description: TODO
* @Author zhengzhenbo
* @Date 2020/8/14
* @Version V1.0
**/
@SpringBootApplication
@EnableZuulProxy
@EnableEurekaClient
public class RunZuulServerApplication {
    public static void main(String[] args) {
    	SpringApplication.run(RunZuulServerApplication.class);
    }
}
```

#### 在com.baidu下新建global.GlobalCorsConfig

##### 解决跨域问题

```
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

/**
 * @ClassName GlobalCorsConfig
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/23
 * @Version V1.0
 **/
@Configuration
public class GlobalCorsConfig {

    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
        //3.返回新的CorsFilter.
        return new CorsFilter(source);
    }
}
```

###  vue项目

删除第5行和第22行,删除完后为一下代码

```
<template>
  <v-card>
      <v-flex xs12 sm10>
        <v-tree url="/category/list" :key="delKey"
                :isEdit="isEdit"
                @handleAdd="handleAdd"
                @handleEdit="handleEdit"
                @handleDelete="handleDelete"
                @handleClick="handleClick"
        />
      </v-flex>
  </v-card>
</template>
<script>
//import {treeData} from '../../mockDB'
export default {
    name: "category",
    data() {
        return {
            isEdit:true
        }
	},
    methods: {
        handleAdd(node) {
            console.log("add .... ");
            console.log(node);
        },
        handleEdit(id, name) {
        	console.log("edit... id: " + id + ", name: " + name)
        },
        handleDelete(id) {
        	console.log("delete ... " + id)
        },
        handleClick(node) {
        	console.log(node)
        }
   }
};
</script>

```

####  Tree.vue

##### getData方法重新制定resp回调

```
<template>
    <v-list class="pt-0 pb-0" dense>
    <TreeItem
        class="item" :model="model" v-for="(model, index) in db" :key="index"
        :url="url"
        :isEdit="isEdit"
        :nodes="nodes"
        @handleAdd="handleAdd"
        @handleEdit="handleEdit"
        @handleDelete="handleDelete"
        @handleClick="handleClick"
        />
    </v-list>
</template>
<script>
import TreeItem from './TreeItem';
export default {
    name: "vTree",
    props: {
    	url: String,
        isEdit: {
            type: Boolean,
            default: false
        },
        treeData:{
        	type:Array
        }
    },
    data() {
        return {
            db: [],
            nodes:{
                opened:null,
                selected:{isSelected:false}
            }
        }
    },
    components: {
    	TreeItem
    },
    created() {
        if(this.treeData && this.treeData.length > 0){
            this.db = this.treeData;
            return;
    	}
   		this.getData();
    },
    methods: {
        getData() {
            //加载一级菜单
            this.$http.get(this.url, {params: {pid: 0}}).then(resp => {
                console.log(resp)
                this.db = resp.data.data;
                this.db.forEach(n => n['path'] = [n.name])
            })
        },
        handleAdd(node) {
        	this.$emit("handleAdd", this.copyNodeInfo(node));
        },
        handleEdit(id, name) {
        	this.$emit("handleEdit", id, name)
        },
        handleDelete(id) {
            this.deleteById(id, this.db);
            this.$emit("handleDelete", id);
        },
        handleClick(node){
        	this.$emit("handleClick", this.copyNodeInfo(node))
        },
        // 根据id删除
        deleteById(id, arr) {
            let src = arr || this.db;
            for (let i in src) {
                let d = src[i];
                if (d.id === id) {
                    src.splice(i, 1)
                    return;
                }
                if (d.children && d.children.length > 0) {
                    this.deleteById(id, d.children)
                }
    		}
    	},
        copyNodeInfo(node){
            const o = {};
            for(let i in node){
                o[i] = node[i];
            }
            return o;
        }
    },
    watch: {}
    }
</script>
<style scoped>
    .item {
    cursor: pointer;
    }
</style>
```

#### TreeItem.vue

修改121回调

```
<template>
  <div>
    <v-list-tile
      @click="toggle" class="level1 pt-0 pb-0 mt-0 mb-0" :class="{'selected':isSelected}">
      <v-list-tile-avatar>
        <v-icon v-if="model.isParent">{{open ? 'folder_open' : 'folder'}}</v-icon>
        <v-icon v-if="!model.isParent">insert_drive_file</v-icon>
      </v-list-tile-avatar>
      <v-list-tile-content>
        <v-list-tile-title v-show="!beginEdit">
          <span >{{model.name}}</span>
        </v-list-tile-title>
        <input v-show="beginEdit" @click.stop="" :ref="model.id" v-model="model.name"
               @blur="afterEdit" @keydown.enter="afterEdit"/>
      </v-list-tile-content>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c1='primary'" @mouseout="c1=''" :color="c1" @click.stop="addChild">
          <i class="el-icon-plus"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c2='success'" @mouseout="c2=''" :color="c2" @click.stop="editChild">
          <i class="el-icon-edit"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c3='error'" @mouseout="c3=''" :color="c3" @click.stop="deleteChild">
          <i class="el-icon-delete"/>
        </v-btn>
      </v-list-tile-action>
    </v-list-tile>

    <v-list v-if="isFolder" v-show="open" class="ml-4 pt-0 pb-0" dense transition="scale-transition">
      <tree-item
        class="item"
        v-for="(model, index) in model.children"
        :key="index"
        :model="model"
        :url="url"
        :isEdit="isEdit"
        :nodes="nodes"
        :parentState="open"
        @handleAdd="handleAdd"
        @handleEdit="handleEdit"
        @handleDelete="handleDelete"
        @handleClick="handleClick"
      >
      </tree-item>
    </v-list>
  </div>
</template>

<script>
  import Vue from 'vue'

  export default {
    name: "tree-item",
    props: {
      model: Object,
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      nodes: Object,
      parentState:Boolean
    },
    created() {
    },
    data: function () {
      return {
        c1: '',
        c2: '',
        c3: '',
        isSelected: false,
        open:false,
        beginEdit:false
      }
    },
    watch:{
      parentState(val){
        if(!val){
          this.open = val;
        }
      }
    },
    computed: {
      isFolder: function () {
        return this.model.children &&
          this.model.children.length > 0
      }
    },
    methods: {
      toggle: function () {
        // 将其它被选中项取消选中
        this.nodes.selected.isSelected = false;
        // 当前项被选中
        this.isSelected = true;
        // 保存当前选中项
        this.nodes.selected = this

        // 客户自己的点击事件回调
        this.handleClick(this.model);

        // 判断是否为顶级节点，顶级节点需要记录和替换
        if(this.model.parentId == 0){
          // 判断打开节点是否是自己
          if(this.nodes.opened && this != this.nodes.opened){
            // 不是，则关闭原来的节点
            this.nodes.opened.open = false;
          }
          // 将自己记录为打开的节点
          this.nodes.opened = this;
        }
        // 切换开闭状态
        this.open = !this.open;
        // 如果已经是叶子节点,或者自己是关闭的，或者自己已经有儿子了，结束
        if (!this.model.isParent || this.isFolder || !this.open) {
          return;
        }
        // 展开后查询子节点
        this.$http.get(this.url, {params: {pid: this.model.id}})
          .then(resp => { 
          Vue.set(this.model, 'children', resp.data.data);  
          // 封装当前节点的路径
          this.model.children.forEach(n => {
            n['path'] = [];
            this.model.path.forEach(p => n['path'].push(p));
            n['path'].push(n.name);
          });
        }).catch( e => {
          console.log(e);
        });
      },
      addChild: function () {
        let child = {
          id: 0,
          name: '新的节点',
          parentId: this.model.id,
          isParent: false,
          sort:this.model.children? this.model.children.length + 1:1
        }
        if (!this.model.isParent) {
          Vue.set(this.model, 'children', [child]);
          this.model.isParent = true;
          this.open = true;
          this.handleAdd(child);
        } else {
          if (!this.isFolder) {
            this.$http.get(this.url, {params: {pid: this.model.id}}).then(resp => {
              Vue.set(this.model, 'children', resp.data);
              this.model.children.push(child);
              this.open = true;
              this.handleAdd(child);
            });
          } else {
            this.model.children.push(child);
            this.open = true;
            this.handleAdd(child);
          }
        }
      },
      deleteChild: function () {
        if(this.model.isParent == 1){
          this.$message.warning('当前节点为父节点');
          return ;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
      editChild() {
        this.beginEdit = true;
        this.$nextTick(() => this.$refs[this.model.id].focus());
      },
      afterEdit() {
        if (this.beginEdit) {
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
      handleAdd(node) {
        this.$emit("handleAdd", node);
      },
      handleDelete(id) {
        this.$emit("handleDelete", id);
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleClick(node) {
        this.$emit("handleClick", node);
      }
    }
  }
</script>

<style scoped>
  .level1 {
    height: 40px;
  }

  .selected {
    background-color: rgba(105,184,249,0.75);
  }
</style>
```

## 商品分类管理(删除)

### vue项目

TreeItem.vue : line 164

```
      deleteChild: function () {
        if(this.model.isParent == 1){
          this.$message.warning('当前节点为父节点');
          return ;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })
      },
```

### Category.vue

```
handleDelete(id) {
    console.log("delete ... " + id);
    this.$http.delete('/category/del?id=' + id).then(response => {
        this.$message.success('删除成功');
        //重新加载树形组件
        this.key = new Date().getTime();//避免key重复
    }).catch(error => console.log(error))
}
```

#### !!!需要在v-tree组件中绑定一个key的属性,默认值为0

```
<v-tree :key="key" url="/category/list">
    data() {
    return {
   		key:0
    }
}
```

###  在mingrui-shop-service-api创建新项目mingrui-shop-service-api-xxx

在 CategoryService接口里面添加

```
@ApiOperation(value = "通过id删除分类")
@DeleteMapping(value = "category/del")
public Result<JsonObject> delCategory(Integer id
```

### 在 mingrui-shop-common-core的com.baidu.shop.utils中新建ObjectUtil类

```
package com.baidu.shop.utils;

/**
 * @ClassName ObjectUtil
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2020/12/22
 * @Version V1.0
 **/
public class ObjectUtil {
    public static Boolean isNull(Object obj){
        return null == obj;
    }

    public static Boolean isNotNull(Object obj){
        return null != obj;
    }
}
```

### 在mingrui-shop-common-core的com.baidu.shop.status的 HTTPStatus中添加

```
public static final int OPERATION_ERROR = 5001;//操作失败
```

## 新增

```java
    @Transactional//事务
    @Override//新增
    public Result<Object> saveCategory(CategoryEntity categoryEntity) {
//        if (categoryEntity.getIsParent() != 1){
//            CategoryEntity cate = new CategoryEntity();
//            cate.setIsParent(1);
//            categoryMapper.updateByPrimaryKeySelective(cate);
//        }

        CategoryEntity cate = new CategoryEntity();
        cate.setId(categoryEntity.getParentId());
        cate.setIsParent(1);
        categoryMapper.updateByPrimaryKeySelective(cate);

        categoryMapper.insertSelective(categoryEntity);
        return this.setResultSuccess();//调用返回成功方法,不用传参数
    }
```

## 修改

Category的修改没有涉及到过多的其他因素,只需要修改本身就可以

```
  @Transactional
    @Override//修改
    public Result<Object> editCategory(CategoryEntity categoryEntity) {
        categoryMapper.updateByPrimaryKeySelective(categoryEntity);
        return this.setResultSuccess();//调用返回成功方法,不用传参数
    }
```



## 三，品牌管理

### 1品牌管理（查询）

#### 1.1 vue项目

##### 1.1.1 官网地址: 表格:https://v15.vuetifyjs.com/zh-Hans/components/data-tables 

##### 输入框:https://v15.vuetifyjs.com/zh-Hans/components/snackbars 

##### 按钮:https://v15.vuetifyjs.com/zh-Hans/components/buttons

##### 1.2 在item包下新建MrBrand.vue

```js
<template>
  <v-card>
    <v-card-title>
      <v-btn @click="addBrand" color="primary">新增品牌</v-btn>
      <v-spacer/>
      <v-text-field
        append-icon="search"
        label="搜索"
        single-line
        hide-details
        v-model="search"
      />
    </v-card-title>
    <v-divider/>
    <v-data-table
      :headers="headers"
      :items="items"
      :pagination.sync="pagination"
      :total-items="totalItems"
      :loading="loading"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center"><img v-if="!!props.item.image" width="102" height="36" :src="props.item.image"/></td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="justify-center layout px-0">
          <v-btn icon @click="editBrand(props.item)">
            <i class="el-icon-edit"/>
          </v-btn>
          <v-btn icon @click="deleteBrand(props.item)">
            <i class="el-icon-delete"/>
          </v-btn>
        </td>
      </template>
      <template slot="expand" slot-scope="props">
        <v-card flat>
          <v-card-text>Peek-a-boo!</v-card-text>
        </v-card>
      </template>
      <template slot="no-data">
        <v-alert :value="true" color="error" icon="warning">
          对不起，没有查询到任何数据 :(
        </v-alert>
      </template>
      <template slot="pageText" slot-scope="props">
        共{{props.itemsLength}}条,当前:{{ props.pageStart }} - {{ props.pageStop }}
      </template>
    </v-data-table>

    <v-dialog v-model="show" max-width="600" scrollable v-if="show">
      <v-card>
        <v-toolbar dark dense color="primary">
          <v-toolbar-title>{{isEdit ? '修改品牌' : '新增品牌'}}</v-toolbar-title>
          <v-spacer/>
          <v-btn icon @click="show = false">
            <v-icon>close</v-icon>
          </v-btn>
        </v-toolbar>
        <v-card-text class="px-5 py-2">
          <!-- 表单 -->
          <brand-form :oldBrand="brand" :isEdit="isEdit" @close="show = false" :reload="getDataFromApi"/>
        </v-card-text>
      </v-card>
    </v-dialog>
  </v-card>

</template>

<script>
  import BrandForm from './BrandForm'
  import {brandData} from '../../mockDB'

  export default {
    name: "brand",
    components: {
      BrandForm
    },
    data() {
      return {
        search: '',// 过滤字段
        totalItems: 0,// 总条数
        items: [],// 表格数据
        loading: true,
        pagination: {},// 分页信息
        headers: [// 表头
          {text: 'id', align: 'center', value: 'id'},
          {text: '名称', align: 'center', sortable: false, value: 'name'},
          {text: 'LOGO', align: 'center', sortable: false, value: 'image'},
          {text: '首字母', align: 'center', value: 'letter', sortable: true,},
          {text: '操作', align: 'center', value: 'id', sortable: false}
        ],
        show: false,// 是否弹出窗口
        brand: {}, // 品牌信息
        isEdit: false // 判断是编辑还是新增
      }
    },
    watch: {
      pagination: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      },
      search: {
        handler() {
          this.getDataFromApi();
        }
      },
      show(val, oldVal) {
        // 表单关闭后重新加载数据
        if (oldVal) {
          this.getDataFromApi();
        }
      }
    },
    mounted() {
      this.getDataFromApi();
    },
    methods: {
      addBrand() {
        this.brand = {};
        this.isEdit = false;
        this.show = true;
      },
      editBrand(item) {
        this.brand = item;
        this.isEdit = true;
        this.show = true;
        // 查询商品分类信息，进行回显
        this.$http.get("/item/category/bid/" + item.id)
          .then(resp => {
            this.brand.categories = resp.data;
          })

      },
      deleteBrand(item) {
        this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
          // 发起删除请求
          this.$http.delete("/item/brand?id=" + item.id,)
            .then(() => {
              // 删除成功，重新加载数据
              this.$message.success("删除成功！");
              this.getDataFromApi();
            })
        }).catch(() => {
          this.$message.info("删除已取消！");
        });

      },
      getDataFromApi() {
        this.loading = true;
        // 200ms后返回假数据
        window.setTimeout(() => {
          this.items = brandData.slice(0,4);
          this.totalItems = 100
          this.loading = false;
        }, 200)
      }
    }
  }
</script>

<style scoped>

</style>

```

##### 2.1.3 index.js line : 27

```js
 route("/item/brand",'/item/MrBrand',"MrBrand"),
```

### 2 common-core 

##### 2.1 pom.xml

```java
    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>

```

2.2 在base包下新建BaseDTO

```java
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import org.apache.commons.lang.StringUtils;

/**
 * 2 * @ClassName BaseDTO
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页",example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页条数",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrderBy(){
        return sort + " " + (Boolean.valueOf(order)?"desc":"asc");
    }

}
```

#### 2.3 mingrui-shop-api 

##### 2.3.1 pom.xml

```java
    <!--分页工具-->
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper-spring-boot-starter</artifactId>
        <version>1.2.10</version>
    </dependency>

```

#### 2.4 mingrui-shop-api-xxx 

##### 2.4.1 在com.baidu.shop下新建dto包 

##### 2.4.1.1 BrandDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * 2 * @ClassName BrandDTO
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "品牌DTO")
@Data
public class BrandDTO extends BaseDTO {

    @Id
    @ApiModelProperty(value = "品牌主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称")
    @NotEmpty(message = "品牌名称不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String name;

    @ApiModelProperty(value = "品牌logo")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;

}

```

##### 2.4.2 entity包下新建BrandEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName BrandEntity
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_brand")
public class BrandEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)//主键自增
    private Integer id;

    private String name;

    private String image;

    private Character letter;
}

```

##### 2.4.2 service包下新建BrandService

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.github.pagehelper.PageInfo;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

/**
 * 2 * @ClassName BrandService
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@Api(tags = "品牌接口")//表示标识这个类是swagger的资源
public interface BrandService {
    @ApiOperation(value = "获得品牌信息")
    @GetMapping(value = "/brand/list")
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO);

    //接口的默认修饰符为private
    @ApiOperation(value = "新增品牌")
    @PostMapping(value = "/brand/save")
    Result<JsonObject> save(@Validated({MingruiOperation.Add.class}) @RequestBody BrandDTO brandDTO);

    @ApiOperation(value = "修改品牌信息")
    @PutMapping(value = "/brand/save")
    Result<JsonObject> editBrand(@Validated({MingruiOperation.Update.class}) @RequestBody BrandDTO brandDTO);


    @ApiOperation(value = "删除品牌信息")
    @DeleteMapping(value = "/brand/deleteBrand")
    Result<JsonObject> deleteBrandId(Integer id);
}

```

#### 2.5 mingrui-shop-service-xxx 

##### 2.5.1 在mapper包下新建BrandMapper

```java
import com.baidu.shop.entity.BrandEntity;
import tk.mybatis.mapper.common.Mapper;

public interface BrandMapper extends Mapper<BrandEntity> {
}

```

##### 2.5.2 在impl包下新建BrandServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.service.BrandService;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

/**
 * 2 * @ClassName BrandServiceImpl
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@RestController
public class BrandServiceImpl extends BaseApiService implements BrandService {

    @Autowired
    private BrandMapper brandMapper;
    
    @Override
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO) {
        //分页
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);

        Example example=new Example(BrandEntity.class);
        //排序
//        if (!StringUtils.isEmpty(brandDTO.getOrder()))
//            example.setOrderByClause(brandDTO.getOrderByClause());
        if(!StringUtils.isEmpty(brandDTO.getSort())) PageHelper.orderBy(brandDTO.getOrderBy());

        example.createCriteria().andLike("name","%"+brandEntity.getName()+"%");

        //查询
        List<BrandEntity> list = brandMapper.selectByExample(example);

        PageInfo<BrandEntity> pageInfo = new PageInfo<>(list);

        return this.setResultSuccess(pageInfo);
    }
}
```

### 3 品牌管理（新增）

- 模态框地址:https://v15.vuetifyjs.com/zh-Hans/components/dialogs
- form表单地址:https://v15.vuetifyjs.com/zh-Hans/components/forms

#### 3.1 vue项目 

##### 3.1.1 新建MrBrandForm.vue

```js
<template>
  <v-form v-model="valid" ref="brandForm">
    <v-text-field
      label="品牌名称"
      v-model="brand.name"
      :rules="[v => !!v || '品牌名称不能为空']"
      :counter="10"
      required
    />
    <v-text-field
      label="首字母"
      v-model="brand.letter"
      :rules="[v => v.length === 1 || '首字母只能是1位']"
      required
      mask="A"
    />
    <v-cascader url="/item/category/list" required
                v-model="brand.categories"
                multiple label="商品分类"/>
    <v-layout row>
      <v-flex xs3>
        <span style="font-size: 16px; color: #444">品牌LOGO：</span>
      </v-flex>
      <v-flex>
        <v-upload
          v-model="brand.image" url="/item/upload" :multiple="false" :pic-width="250" :pic-height="90"
        />
      </v-flex>
    </v-layout>
    <v-layout class="my-4">
      <v-btn @click="submit" color="primary">提交</v-btn>
      <v-btn @click="clear" color="warning">重置</v-btn>
    </v-layout>
  </v-form>
</template>

<script>
  import config from '@/config';
  export default {
    name: "brand-form",
    props: {
      oldBrand: Object,
      isEdit: {
        type: Boolean,
        default: false
      },
      show: {
        type: Boolean,
        default: true
      }
    },
    data() {
      return {
        baseUrl: config.api,
        valid:false,
        brand: {
          name: "",
          image: "",
          letter: "",
          categories: []
        },
        imageDialogVisible:false
      }
    },
    watch: {
      oldBrand:{
        deep:true,
        handler(val){
          Object.deepCopy(val,this.brand);
        }
      }
    },
    methods: {
      submit() {
        // 表单校验
        if (this.$refs.brandForm.validate()) {
          this.brand.categories = this.brand.categories.map(c => c.id);
          this.brand.letter = this.brand.letter.toUpperCase();
          // 将数据提交到后台
          this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/item/brand',
            data: this.$qs.stringify(this.brand)
          }).then(() => {
            // 关闭窗口
            this.$message.success("保存成功！");
            this.closeWindow();
          }).catch(() => {
            this.$message.error("保存失败！");
          });
        }
      },
      clear() {
        // 重置表单
        this.$refs.brandForm.reset();
        this.categories = [];
      },
      // 图片上传出成功后操作
      handleImageSuccess(res) {
        this.brand.image = res;
      },
      removeImage(){
        this.brand.image = "";
      },
      closeWindow(){
        this.$emit("close");
      }
    }
  }
</script>

<style scoped>

</style>

```

##### 3.1.2 Casecader.vue需要修改113行 

```js
	then(resp => {//改
            const data = [];
            for (let d of resp.data.data) {//改,line:113
              const node = {
                value: d[this.itemValue],
                label: d[this.itemText]
              }
              if (d.isParent) {
                node['children'] = [];
                node['loading'] = false;
              }
              data.push(node)
            }
            resolve(data);
          })
```

##### 3.1.3 MrBrand.vue,查询那个vue

#### 3.2 common-core 

##### 3.2.1 在utils包下新建BaiduBeanUtil

```java
package com.baidu.shop.utils;

import org.springframework.beans.BeanUtils;

/**
 * 2 * @ClassName BaiduBeanUtil
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
public class BaiduBeanUtil {
    public static <T> T copyProperties(Object source,Class<T> clazz){

        try {
            T t = clazz.newInstance();//创建当前类型的实例
            BeanUtils.copyProperties(source,t);
            return t;
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }

        return null;
    }
}

```

#### 3.3 mingrui-shop-service-api-xxx 

##### 3.3.1 BrandDTO

```java
	@ApiModelProperty(value = "品牌id集合")
    @NotEmpty(message = "品牌分类信息不能为空",groups = {MingruiOperation.Add.class})
    private String categories;
```



##### 3.3.2 entity包下新建CategoryBrandEntity

```java
package com.baidu.shop.entity;

import io.swagger.annotations.ApiModel;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Table;

/**
 * 2 * @ClassName CategoryBrandEntity
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/28
 * 6 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_category_brand")
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {
    private Integer categoryId;

    private Integer brandId;
}

```

##### 3.3.3 BrandService,新增的service有

​      @ApiOperation(value = "新增品牌") 

​      @PostMapping(value = "brand/addBrandInfo") 

​      public Result<JSONObject> save(@Validated({MingruiOperation.Add.class}) @RequestBody BrandDTO brandDTO);

##### 3.4.2 BrandServiceImpl

封装方法

```java
	@Autowired
    private CategoryBrandMapper categoryBrandMapper;

//通过brandId删除中间表的数据
private void deleteCategoryBrandList(Integer id){
    Example example = new Example(CategoryBrandEntity.class);
    example.createCriteria().andEqualTo("brandId",id);
    categoryBrandMapper.deleteByExample(example);
}

private void insertBrandId(String categories,Integer brandId){

    if (StringUtils.isEmpty(categories)) throw new RuntimeException();
    if (categories.contains(",")){
        categoryBrandMapper.insertList(
                Arrays.asList(categories.split(","))
                        .stream()
                        .map(categoryIds->new CategoryBrandEntity(Integer.valueOf(categoryIds),brandId))
                        .collect(Collectors.toList())
        );
    }else{
        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
        categoryBrandEntity.setBrandId(brandId);
        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }
}
```

##### 新增impl

```java
 @Override
    public Result<JsonObject> save(BrandDTO brandDTO) {
        //新增返回主键
        //两种方式实现 select-key insert加两个属性

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);//处理品牌首字母
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
        brandMapper.insertSelective(brandEntity);

        //维护中间表数据
        //String categories = brandDTO.getCategories();//得到分类集合字符串
        //if (StringUtils.isEmpty(brandDTO.getCategories())) return this.setResultError("新球，错了");
//        ArrayList<CategoryBrandEntity> categoryBrandEntities = new ArrayList<>();

        this.insertBrandId(brandDTO.getCategories(),brandEntity.getId());


        return this.setResultSuccess();
    }
```

##### 4.1.3.1mingrui-shop-service-xxx下创建 CategoryMapper

```java
import com.baidu.shop.entity.CategoryEntity;

import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;


public interface CategoryMapper extends Mapper<CategoryEntity> {

    @Select(value = "SELECT id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}
```

##### 修改impl

```java
@Transactional
@Override
public Result<JsonObject> editBrand(BrandDTO brandDTO) {
    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
    brandMapper.updateByPrimaryKeySelective(brandEntity);

    //先通过brandId删除中间表的数据
    //封装的方法
    this.deleteCategoryBrandList(brandEntity.getId());

    //批量新增 / 新增
    //String categories = brandDTO.getCategories();//得到分类集合字符串

    this.insertBrandId(brandDTO.getCategories(),brandEntity.getId());

    return this.setResultSuccess();
}
```

##### 删除impl

```java
@Override
public Result<JsonObject> deleteBrandId(Integer id) {
    brandMapper.deleteByPrimaryKey(id);
    //封装方法-----通过brandId删除中间表的数据
    this.deleteCategoryBrandList(id);
    return this.setResultSuccess();
}
```



### 4品牌首字母自动识别

#### 4.1 common-core 

##### 4.1.2.1 pom.xml

```java
    <dependency>
        <groupId>com.belerweb</groupId>
        <artifactId>pinyin4j</artifactId>
        <version>2.5.1</version>
    </dependency>

```

##### 4.1.2.2 在utils包下新建PinyinUtil

```java
package com.baidu.shop.utils;

import net.sourceforge.pinyin4j.PinyinHelper;
import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;
import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * 2 * @ClassName PinyinUtil
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2020/12/28
 * 6 * @Version V1.0
 * 7
 **/
public class PinyinUtil {
    public static final Boolean TO_FUUL_PINYIN = true;
    public static final Boolean TO_FIRST_CHAR_PINYIN = false;
    /**
     * 获取汉字首字母或全拼大写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母大写字符窜
     */
    public static String getUpperCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toUpperCase();
    }
    /**
     * 获取汉字首字母或全拼小写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母小写字符窜
     */
    public static String getLowerCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toLowerCase();
    }
    /**
     * 将汉字转成拼音
     * <p>
     * 取首字母或全拼
     *
     * @param hanzi 汉字字符串
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 拼音
     */
    private static String convertHanzi2Pinyin(String hanzi, boolean isFull) {
        /***
         * ^[\u2E80-\u9FFF]+$ 匹配所有东亚区的语言
         * ^[\u4E00-\u9FFF]+$ 匹配简体和繁体
         * ^[\u4E00-\u9FA5]+$ 匹配简体
         */
        String regExp = "^[\u4E00-\u9FFF]+$";
        StringBuffer sb = new StringBuffer();
        if (hanzi == null || "".equals(hanzi.trim())) {
            return "";
        }
        String pinyin = "";
        for (int i = 0; i < hanzi.length(); i++) {
            char unit = hanzi.charAt(i);
//是汉字，则转拼音
            if (match(String.valueOf(unit), regExp)) {
                pinyin = convertSingleHanzi2Pinyin(unit);
                if (isFull) {
                    sb.append(pinyin);
                } else {
                    sb.append(pinyin.charAt(0));
                }
            } else {
                sb.append(unit);
            }
        }
        return sb.toString();
    }
    /**
     * 将单个汉字转成拼音
     *
     * @param hanzi 汉字字符
     * @return 拼音
     */
    private static String convertSingleHanzi2Pinyin(char hanzi) {
        HanyuPinyinOutputFormat outputFormat = new HanyuPinyinOutputFormat();
        outputFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);
        String[] res;
        StringBuffer sb = new StringBuffer();
        try {
            res = PinyinHelper.toHanyuPinyinStringArray(hanzi, outputFormat);
            sb.append(res[0]);//对于多音字，只用第一个拼音
        } catch (Exception e) {
            e.printStackTrace();
            return "";
        }
        return sb.toString();
    }
/**
 * 匹配
 * <P>
 * 根据字符和正则表达式进行匹配
 *
 * @param str 源字符串
 *  @param regex 正则表达式
 *
 *  @return true：匹配成功 false：匹配失败
 * */
    private static boolean match(String str, String regex) {
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(str);
        return matcher.find();
    }

}
```

### 5,图片上传

1. ##### vue项目

2. ##### Upload.vue line:88&89

   ```js
   		this.dialogImageUrl = file.response.data;
           this.$emit("input", file.response.data)
   ```

3. ##### MrBrandForm.vue,   在1.2中的vue中

4. ##### 在mingrui-shop-basics下新建mingrui-shop-basic-uploadserver

   1. ###### pom.xml

      ```java
      <dependencies>
          <!-- SpringBoot-整合Web组件 -->
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-web</artifactId>
          </dependency>
          <dependency>
              <groupId>com.baidu</groupId>
              <artifactId>mingrui-shopcommon-core</artifactId>
              <version>1.0-SNAPSHOT</version>
          </dependency>
      </dependencies>
      ```

   2. ###### application.yml

      ```java
      server:
        port: 8200
      spring:
        application:
          name: upload-server
      eureka:
        client:
          service-url:
            defaultZone: http://localhost:8761/eureka
      
      mingrui:
        upload:
          path:
            windows: D:\\images
            linux: /zhengzhenbo/images
          img:
            host: http://image.mrshop.com
      ```

   3. 启动类

      ```java
      package com.baidu;
      
      import org.springframework.boot.SpringApplication;
      import org.springframework.boot.autoconfigure.SpringBootApplication;
      import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
      
      /**
       * 2 * @ClassName RunUploadServerApplication
       * 3 * @Description: TODO
       * 4 * @Author zhengzhenbo
       * 5 * @Date 2020/12/29
       * 6 * @Version V1.0
       * 7
       **/
      @SpringBootApplication
      @EnableEurekaClient
      public class RunUploadServerApplication {
          public static void main(String[] args) {
              SpringApplication.run(RunUploadServerApplication.class);
          }
      }
      ```

   4. 新建包com.baidu.shop.upload.controller，

   5. 在包下新建UploadController

      ```java
      package com.baidu.shop.upload.controller;
      
      import com.baidu.shop.base.BaseApiService;
      import com.baidu.shop.base.Result;
      import com.baidu.shop.status.HTTPStatus;
      import org.springframework.beans.factory.annotation.Value;
      import org.springframework.web.bind.annotation.*;
      import org.springframework.web.multipart.MultipartFile;
      
      import java.io.File;
      import java.io.IOException;
      import java.util.UUID;
      
      /**
       * 2 * @ClassName UploadController
       * 3 * @Description: TODO
       * 4 * @Author zhengzhenbo
       * 5 * @Date 2020/12/29
       * 6 * @Version V1.04
       * 7
       **/
      @RestController
      @RequestMapping(value = "upload")
      public class UploadController extends BaseApiService {
          //linux系统的上传目录
          @Value(value = "${mingrui.upload.path.windows}")
          private String windowsPath;
          //window系统的上传目录
          @Value(value = "${mingrui.upload.path.linux}")
          private String linuxPath;
          //图片服务器的地址
          @Value(value = "${mingrui.upload.img.host}")
          private String imageHost;
          @PostMapping
          public Result<String> uploadImg(@RequestParam MultipartFile file) {
              if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的
              //文件是否为空
              String filename = file.getOriginalFilename();//获取文件名
              String path = "";
              String os = System.getProperty("os.name").toLowerCase();
              if(os.indexOf("win") != -1){
                  path = windowsPath;
              }else if(os.indexOf("lin") != -1){
                  path = linuxPath;
              }
              filename = UUID.randomUUID() + filename;//防止文件名重复
              //创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
              File dest = new File(path + File.separator + filename);
              //判断文件夹是否存在,不存在的话就创建
              if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();
              try {
                  file.transferTo(dest);//上传
              } catch (IllegalStateException e) {
              // TODO Auto-generated catch block
                  e.printStackTrace();
              } catch (IOException e) {
              // TODO Auto-generated catch block
                  e.printStackTrace();
              }
              return this.setResult(HTTPStatus.OK,"upload success!!!",imageHost + "/"+ filename);//将文件名返回页面用于页面回显
          }
      
      }
      ```

   6. 新建包:com.baidu.global

   7. GlobalCorsConfig

      ```java
      package com.baidu.global;
      
      import org.springframework.context.annotation.Bean;
      import org.springframework.context.annotation.Configuration;
      import org.springframework.web.cors.CorsConfiguration;
      import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
      import org.springframework.web.filter.CorsFilter;
      
      
      /**
       * 2 * @ClassName GlobalCorsConfig
       * 3 * @Description: TODO
       * 4 * @Author zhengzhenbo
       * 5 * @Date 2020/12/29
       * 6 * @Version V1.0
       * 7
       **/
      @Configuration
      public class GlobalCorsConfig {
          @Bean
          public CorsFilter corsFilter() {
              final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
              final CorsConfiguration config = new CorsConfiguration();
              config.setAllowCredentials(true); // 允许cookies跨域
              config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
              config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
              config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
              config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
              config.addAllowedMethod("HEAD");
              config.addAllowedMethod("GET");// 允许Get的请求方法
              config.addAllowedMethod("PUT");
              config.addAllowedMethod("POST");
              config.addAllowedMethod("DELETE");
              config.addAllowedMethod("PATCH");
              source.registerCorsConfiguration("/**", config);
              //3.返回新的CorsFilter.
              return new CorsFilter(source);
          }
      
      }
      ```

   8. 使用postman测试上传

   9. 我们将利用nginx来做代理服务,代理本地目录

   10. hosts文件中新增

       ```
    127.0.0.1 image.mrshop.com
       ```
   
   11. nginx-home/conf/nginx.conf新增

       ```java
    	server {
               listen 	80;
               server_name image.mrshop.com;
               
               proxy_set_header X-Forwarded-Host $host;
               proxy_set_header X-Forwarded-Server $host;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               
               location ~ .*\.(gif|jpg|pdf|jpeg|png)$
               {
               	#root D:/nginx-1.15.5/temp/images/;#指定图片存放路径(可以放在nginx文件夹路
              	 	径里也可以放其他p盘)
               	root E:\images;
               }
               
               location / {
           		root html;
           		index index.html index.htm;
           	}
           }
       
       ```
   
       

   12. 重启nginx

       ```
    nginx.exe -s reload
       ```
   
   13. 浏览器输入http://image.mrshop.com/imageName.jpg测试

   14. zuul的application.yml

       ```
    zuul:
         # 声明路由
         routes:
           # 路由名称
           api-xxx:
             # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
             path: /api-xxx/**
             serviceId: xxx-server
         # 启用重试
         retryable: true
         # 包含此路径的不进行路由
         ignored-patterns: /upload/**
         # 忽略上传服务
         ignored-services:
           -upload-server
       
       ```
   
       

   15. 在nginx-home/conf/nginx.conf 添加api.mrshop.com的代理配置

       ```
        # 上传路径的映射
           # 只要包含/api-xxx/upload 都会把请求映射到8200服务
           # rewrite "^/api-xxx/(.*)$" /$1 break;
           # 将/api-xxx 替换成/
           location /api-xxx/upload {
               proxy_pass http://127.0.0.1:8200;
               proxy_connect_timeout 600;
               proxy_read_timeout 600;
               
               rewrite "^/api-xxx/(.*)$" /$1 break;
           }
       
       ```
   
        **品牌管理(修改)**
    
       ​	回显
    
       #### 后台
       
       mingrui-shop-service-api-xxx
       
       Service：CategoryService
       
       ```
       @ApiOperation(value = "通过品牌id查询商品分类")
       @GetMapping(value = "category/getByBrand")
       Result<List<CategoryEntity>> getByBrand (Integer brandId);
       ```
       
       mingrui-shop-service-xxx
       
       com.baidu.shop.mapper：CategoryMapper
       
       ```
       @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
       ```
       
       com.baidu.shop.service.impl：CategoryServiceImpl
       
       ```
       //通过品牌查询商品id
       @Override
       public Result<List<CategoryEntity>> getByBrand(Integer brandId) {
           List<CategoryEntity> byBrandId = categoryMapper.getByBrandId(brandId);
           return this.setResultSuccess(byBrandI);
       }
       ```
       
       #### 前台
       
        MrBrand.vue
       
       ```
       <template>
         <v-card>
           <v-card-title>
             <v-btn color="info" @click="dialog = true">新增</v-btn>
             <div class="text-xs-center">
               <v-dialog v-model="dialog" width="500">
                 <v-card>
                   <v-card-title class="headline grey lighten-2" primary-title>
                   品牌 {{isEdit?'修改':'新增'}}
                  </v-card-title>
                   <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail"/>
                 </v-card>
               </v-dialog>
             </div>
             <!-- 调按钮和输入框之间的间距 -->
             <v-spacer />
             <!--append-icon : 图标 label : input默认值-->
             <v-text-field
               append-icon="search"
               label="品牌名称"
               @keyup.enter="getTableData()"
               v-model="search"
             ></v-text-field>
           </v-card-title>
           <v-data-table
             :headers="headers"
             :items="desserts"
             :pagination.sync="pagination"
             :total-items="total"
             class="elevation-1"
           >
             <!-- 注意此处不能只能用官网的属性,应当参照Brand.vue的写法 -->
             <template slot="items" slot-scope="props">
               <td class="text-xs-center">{{ props.item.id }}</td>
               <td class="text-xs-center">{{ props.item.name }}</td>
               <!-- :src 给元素绑定src属性 属性的值为props.item.image -->
               <td class="text-xs-center">
                 <img width="200" :src="props.item.image" />
                 </td>
               <td class="text-xs-center">{{ props.item.letter }}</td>
               <td class="text-xs-center">
                   <v-btn falt icon  @click="editDialog(props.item)" color="green">
                       <v-icon>edit</v-icon>
                   </v-btn>
                   <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                       <v-icon>delete</v-icon>
                   </v-btn>
               </td>
             </template>
           </v-data-table>
         </v-card>
       </template>
       <script>
       import MrBrandForm from './MrBrandForm';
       export default {
         name: "MrBrand",
         components:{
           MrBrandForm
         },
         data() {
           return {
             brandDetail:{},
             isEdit:false,
             dialog:false,
             pagination: {},
             total: 0,
             search: "",
             headers: [
               {
                 text: "id",
                 align: "center",
                 value: "id",
               },
               {
                 text: "品牌名称",
                 align: "center",
                 value: "name",
               },
               {
                 text: "品牌logo",
                 align: "center",
                 value: "image",
               },
               {
                 text: "首字母",
                 align: "center",
                 value: "letter",
               },
               {
                 text: "操作",
                 align: "center",
                 sortable: false,
                 value: "id",
               }
             ],
             desserts: [],
           };
         },
         mounted() {
           this.getTableData();
         },
         methods: {
           closeDialog(){
             this.dialog = false;
             this.getTableData()
           },
           addDialog(){
             this.isEdit = false;
             this.dialog = true;
           },
           editDialog(obj){
             this.brandDetail = obj;
             this.isEdit = true;
             this.dialog = true;
           },
           delDialog(id){
             this.$http.delete('brand/del?id=' + id).then(resp =>{
               if(resp.data.code == 200){
                   this.getTableData()
                   this.$message.success('删除成功')
               }else{
                 this.$message.error(resp.data.msg)
               }
             }).catch(error => console.log(error))
           },
           getTableData() {
             this.$http
               .get("/brand/list", {
                 params: {
                   page: this.pagination.page,
                   rows: this.pagination.rowsPerPage,
                   sort: this.pagination.sortBy,
                   order: this.pagination.descending,
                   name: this.search,
                 },
               })
               .then((resp) => {
                 this.desserts = resp.data.data.list;
                 this.total = resp.data.data.total;
               })
               .catch((error) => console.log(error));
           },
         },
         watch: {
           pagination() {
             this.getTableData();
           },
         },
       };
       </script>
       ```
       
       MrBrandForm.vue
       
       ```
       <template>
           <div>
                   <v-form v-model="valid" ref="form">
                       <v-text-field v-model="brand.name" label="品牌名称" :rules="nameRules" required></v-text-field>
                       <v-cascader url="/category/list" required v-model="brand.categories" multiple label="商品分类"/>
                       <!-- 文件上传 -->
                       <v-layout row>
                           <v-flex xs3>
                             <span style="font-size: 16px; color: #444">品牌LOGO:</span>
                           </v-flex>
                           <v-flex>
                               <v-upload
                                 v-model="brand.image"
                                 url="/upload"
                                 :multiple="false"
                                 :pic-width="250"
                                 :pic-height="100"
                               />
                           </v-flex>
                       </v-layout> 
                   </v-form>
                <v-card-actions>
                 <v-spacer></v-spacer>
                 <v-btn small @click="cancel()">取消</v-btn>
                 <v-btn small color="red"  @click="submitForm">确认</v-btn>
               </v-card-actions>
           </div>
       </template>
       <script>
         export default {
           name:"MrBrandForm",
           props:{
             //父组件传递过来的模态框状态
             dialog: Boolean,
             brandDetail: Object,
             isEdit: Boolean
           },
           watch:{
             dialog(val){
               if(val) this.$refs.form.reset();
             },
             brandDetail(val){
               if(this.isEdit){
                   this.$http.get('category/getByBrand',{
                     params:{
                       brandId:val.id
                     }
                   }).then(resp =>{
                     console.log(resp);
                     let brand = val;
                     brand.categories = resp.data.data;
                     this.brand = brand;
                   }).catch(error => console.log(error))
                   // this.brand=val;
               }
             }
           },
           data () {
             //在js中 null == false , '' == false , undefined == false , 0 == false
             return {
               valid: true,
               nameRules:[
                 (v) => !!v || '品牌名称不能为空',
                 (v) => (v && v.length <= 10) || '品牌名称长度最长10'
               ],
               brand:{
                   name:"",
                   letter:"",
                   categories:[],
                 
               }
             }
           },
           methods:{
               cancel(){
                   this.$emit("closeDialog");
               },
               submitForm(){
                   if(!this.$refs.form.validate()){
                       return;
                   }
                   let fromData = this.brand;
                   let categoryIdArr = this.brand.categories.map(category =>category.id);
                   fromData.categories = categoryIdArr.join();
       
                   //$.ajax() 和 $.get() | $.post()方法的区别?
                   this.$http({
                     url:'/brand/save',
                     data:fromData,
                     method:this.isEdit ? 'put':'post'
                     }).then(resp=>{
                       if(resp.data.code != 200){
                           return;
                       }
                          //关闭模态框
                           this.cancel();
                   }).catch(error => console.log(error))
               }
           }   
         }
       </script>
       ```
       
       ### 修改
       
       #### 后台
       
       mingrui-shop-service-api-xxx
       
       com.baidu.shop.service：BrandService
       
       ```
       @PutMapping(value = "brand/save")
       @ApiOperation(value = "修改品牌")
       Result<JsonObject> eidt(@RequestBody BrandDto brandDto);
       ```
       
       mingrui-shop-service-xxx
       
       com.baidu.shop.service.impl：BrandServiceImpl
       
       ```
       //修改品牌
       @Transactional
       @Override
       public Result<JsonObject> eidt(BrandDto brandDto) {
       
       
           BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDto, BrandEntity.class);
       
           brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
           brandMapper.updateByPrimaryKeySelective(brandEntity);
           //先通过brandId删除中间表的数据
           this.delteCategoryByBrandId(brandEntity.getId());
           //批量新增 / 新增
           this.insetrCategoryBrandList(brandDto.getCategories(),brandEntity.getId());
           return this.setResultSuccess();
       }
       ```
       
       ```
       //新增修改整合
       private void insetrCategoryBrandList (String categories,Integer brandId){
           if (StringUtils.isEmpty(categories))throw new RuntimeException("分类信息不能为空");
       
           //判断分类集合字符串中是否包含,
           if(categories.contains(",")){
               categoryBrandMapper.insertList(
                   //数组转list
                   Arrays.asList(categories.split(","))
                           //获取stream流，流：对一次数据进行操作
                           .stream()
                           //遍历list中所有数据
                           .map(categoryById->new CategoryBrandEntity(Integer.valueOf(categoryById),brandId))
                           //最终转换成list
                           .collect(Collectors.toList())
               );
           }else{
               CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
               categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
               categoryBrandEntity.setBrandId(brandId);
       
               categoryBrandMapper.insertSelective(categoryBrandEntity);
           }
       }
       ```
       
       **前台**
       
       ```
       submitForm(){
                   if(!this.$refs.form.validate()){
                       return;
                   }
                   let fromData = this.brand;
                   let categoryIdArr = this.brand.categories.map(category =>category.id);
                   fromData.categories = categoryIdArr.join();
       
                   //$.ajax() 和 $.get() | $.post()方法的区别?
                   this.$http({
                     url:'/brand/save',
                     data:fromData,
                     method:this.isEdit ? 'put':'post'
                     }).then(resp=>{
                       if(resp.data.code != 200){
                           return;
                       }
                          //关闭模态框
                           this.cancel();
                   }).catch(error => console.log(error))
               }
       ```
       
       ## 4.品牌删除
       
       ### 后台
       
       mingrui-shop-service-api-xxx
       
       com.baidu.shop.service：BrandService
       
       ```
       @DeleteMapping(value = "brand/del")
       @ApiOperation(value = "删除品牌")
       Result<JsonObject> del( Integer id);
       ```
       
       mingrui-shop-service-xxx：BrandServiceImpl
       
       ```
       //删除品牌
       @Override
       public Result<JsonObject> del(Integer id) {
           //删除品牌信息
           brandMapper.deleteByPrimaryKey(id);
           this.delteCategoryByBrandId(id);
           return this.setResultSuccess();
       }
       
       private void  delteCategoryByBrandId (Integer brandId){
           Example example = new Example(CategoryBrandEntity.class);
           example.createCriteria().andEqualTo("brandId",brandId);
           categoryBrandMapper.deleteByExample(example);
       }
       ```
       
       **前台**
       
       ```
       <v-btn falt icon @click="delDialog(props.item.id)" color="red">
                       <v-icon>delete</v-icon>
                   </v-btn>
       ```
       
       ```
       delDialog(id){
             this.$http.delete('brand/del?id=' + id).then(resp =>{
               if(resp.data.code == 200){
                   this.getTableData()
                   this.$message.success('删除成功')
               }else{
                 this.$message.error(resp.data.msg)
               }
             }).catch(error => console.log(error))
           },
       ```
       
       
   

## 四，商品规格参数管理

#### 1 加载分类信息

##### 1.1 vue项目

###### 1.1.1 index.js line:29

```javascript
route("/item/specification",'/item/specification/Specification',"Specification"),
```

###### 1.1.2 specification/Specification.vue

```html
<!--修改成我们自己的url-->
<v-tree url="/category/list"
                  :isEdit="false"
                  @handleClick="handleClick"
          />
```

#### 2 规格组(查询)

##### 2.1 vue项目 

##### 2.1.1 SpecGroup.vue

line:72，路径

```javascript
loadData(){
          this.$http.get("/specgroup/groups" , {
              params:{
                  cid:this.cid
              }
          })
          .then(({data}) => {
              this.groups = data.data;
          })
          .catch(() => {
              this.groups = [];
          })
      },
```

##### 2.2 mingrui-shop-service-api-xxx

##### 2.2.1 entity包下新建SpecGroupEntity

```java
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName SpecGroupEntity
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spec_group")
@Data
public class SpecGroupEntity {

    @Id
    private Integer id;

    private Integer cid;

    private String name;
}
```

##### 2.2.2 dto包下新建SpecGroupDTO

```java
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * 2 * @ClassName SpecGroupDTO
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "规格组数据传输DTO")
@Data
public class SpecGroupDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键id不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id",example = "1")
    @NotNull(message = "类型Id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组名称")
    @NotEmpty(message = "规格组名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;
}
```

##### 2.2.3 service包下新建SpecificationService

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

@Api(tags = "规格接口")
public interface SpecificationService {

    @ApiOperation(value = "通过条件查询规格组")
    @GetMapping(value = "specgroup/groups")
    Result<List<SpecGroupEntity>> getSepcGroupInfo(SpecGroupDTO specGroupDTO);
}
```

##### 2.3 mingrui-shop-service-xxx 

##### 2.3.1 mapper包下新建SpecGroupMapper

```java
import com.baidu.shop.entity.SpecGroupEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecGroupMapper extends Mapper<SpecGroupEntity> {
}
```

##### 2.3.2 service.impl包下新建SpecificationServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import com.baidu.shop.mapper.SpecGroupMapper;
import com.baidu.shop.service.SpecificationService;
import com.baidu.shop.utils.ObjectUtil;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class SpecificationServiceImpl extends BaseApiService implements SpecificationService {

    @Resource
    private SpecGroupMapper specGroupMapper;
    
    @Override
    public Result<List<SpecGroupEntity>> getSepcGroupInfo(SpecGroupDTO specGroupDTO) {
        Example example = new Example(SpecGroupEntity.class);
        if (ObjectUtil.isNotNull(specGroupDTO.getCid()))
            example.createCriteria().andEqualTo("cid", BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class).getCid());
        
        List<SpecGroupEntity> specGroupEntities = specGroupMapper.selectByExample(example);
        return this.setResultSuccess(specGroupEntities);
    }
}
```

#### 3 规格组(新增,删除,修改)

##### 3.1 vue项目 

###### 3.1.1 SpecGroup.vue

```js
save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specgroup/save',
            data: this.group
          }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      },
      deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("specgroup/delete/" + id)
                .then(resp => {
                    if (resp.data.code != 200) {
                        this.$message.error(resp.data.message);
                        return;
                    }
                    this.$message.success("删除成功");
                    this.loadData();
                })
          })
      },
```

##### 3.2 mingrui-shop-service-api-xxx 

###### 3.2.1 SpecificationService

```java
 @ApiOperation(value = "增加规格组")
    @PostMapping(value = "specgroup/save")
    Result<JsonObject> saveSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "修改规格组")
    @PutMapping(value = "specgroup/save")
    Result<JsonObject> editSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "删除规格组")
    @DeleteMapping(value = "specgroup/delete/{id}")
    Result<JsonObject> deleteSpecGroup(@PathVariable Integer id);
```

##### 3.3 mingrui-shop-service-xxx 

###### 3.3.1 SpecificationServiceImpl

```java
 @Resource
 private SpecParamMapper specParamMapper;

@Transactional
    @Override
    public Result<JsonObject> saveSpecGroup(SpecGroupDTO specGroupDTO) {
        specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));

        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> editSpecGroup(SpecGroupDTO specGroupDTO) {
        specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> deleteSpecGroup(Integer id) {

        //删除规格组之前需要先判断一下当前规格组下是否有规格参数
        //true : 不能被删除
        //false -->
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",id);
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        
        if (specParamEntities.size()!=0) return this.setResultError(HTTPStatus.OPERATION_ERROR,"当前规格组下有参数，请先删除规格组下的内容");

        specGroupMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
```

#### 4 规格参数(查询) 

##### 4.1 vue项目 

###### 4.1.1 SpecParam.vue

line:125

```js
loadData() {
      this.$http
        .get("/specparam/groups",{
          params:{
            groupId:this.group.id
          }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
```

##### 4.2 mingrui-shop-service-api-xxx 

###### 4.2.1 entity包下新建SpecParamEntity

```java
import lombok.Data;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName SpecParamEntity
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spec_param")
@Data
public class SpecParamEntity {
    @Id
    private Integer id;

    private Integer cid;

    private Integer groupId;

    private String name;

    //1左边的点，numeric是数据库关键字
    @Column(name = "`numeric`")
    private Boolean numeric;

    private String unit;

    private Boolean generic;

    private Boolean searching;

    private String segments;

}

```

###### 4.2.2 dto包下新建SpecParamDTO

```java
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;

/**
 * 2 * @ClassName SpecParamDTO
 * 3 * @Description: TODO
 * 4 * @Author zhengzhenbo
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "规格参数数据传输DTO")
@Data
public class SpecParamDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id",example = "1")
    private Integer cid;

    @ApiModelProperty(value = "规格组id")
    private Integer groupId;

    @ApiModelProperty(value = "规格参数名称")
    private String name;

    @ApiModelProperty(value = "是否是数字类型参数",example = "0")
    @NotNull(message = "是否是数字类型参数不能为空",groups = {MingruiOperation.Update.class})
    private Boolean numeric;

    @ApiModelProperty(value = "数字类型参数的单位，非数字类型可以为空")
    private String unit;

    @ApiModelProperty(value = "是否是sku通用属性")
    @NotNull(message = "是否是sku通用属性不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Boolean generic;

    @ApiModelProperty(value = "是否用于搜索过滤")
    @NotNull(message = "是否用于搜索过滤不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean searching;

    @ApiModelProperty(value = "数值类型参数，如果需要搜索，则添加分段间隔值")
    private String segments;
}

```

###### 4.2.3 SpecificationService

```java
    @ApiOperation(value = "查询规格参数")
    @GetMapping(value = "/specparam/groups")
    Result<List<SpecParamEntity>> getSepcParamInfo(SpecParamDTO specParamDTO);
```

##### 4.3 mingrui-shop-service-xxx 

###### 4.3.1 mapper包下新建SpecParamMapper

```java
import com.baidu.shop.entity.SpecParamEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecParamMapper extends Mapper<SpecParamEntity> {
}
```

##### 4.3.2 SpecificationServiceImpl

```java
	//@Resource
	//private SpecParamMapper specParamMapper;
	
	@Override
    public Result<List<SpecParamEntity>> getSepcParamInfo(SpecParamDTO specParamDTO) {
        SpecParamEntity specParamEntity = 
            BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);

        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamEntity.getGroupId());
        List<SpecParamEntity> specParamEntities = 													specParamMapper.selectByExample(example);
        
        return this.setResultSuccess(specParamEntities);
    }
```

#### 5 规格参数(增,删,改) 

##### 5.1 vue项目 

3.5.1.1 SpecParam.vue

line:156

```js
addParam() {
      this.param = {
          cid: this.group.cid,
          groupId: this.group.id,
          segments:[],
          numeric:false,
          searching:false,
          generic:false}
      this.show = true;
      this.isEdit = false;
    },
```

```js
deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("specparam/delete?id=" + id)
            .then(() => {
              
                this.$message.success("删除成功");
                this.loadData();
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    },
    formatBoolean(boo) {
      return boo ? "是" : "否";
    },
    save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specparam/save',
            data: p,
        }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
```

##### 5.2 mingrui-shop-service-api-xxx 

5.2.1 SpecificationService

```java
@ApiOperation(value = "增加规格参数")
    @PostMapping(value = "/specparam/save")
    Result<JsonObject> saveSpecParam(@RequestBody SpecParamDTO specParamDTO);

    @ApiOperation(value = "修改规格参数")
    @PutMapping(value = "/specparam/save")
    Result<JsonObject> editSpecParam(@RequestBody SpecParamDTO specParamDTO);


    @ApiOperation(value = "删除规格参数")
    @DeleteMapping(value = "/specparam/delete")
    Result<JsonObject> deleteSpecParam(Integer id);
```

#####  mingrui-shop-service-xxx 

######  SpecificationServiceImpl

```java
@Transactional
    @Override
    public Result<JsonObject> saveSpecParam(SpecParamDTO specParamDTO) {
        specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> editSpecParam(SpecParamDTO specParamDTO) {
        specParamMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> deleteSpecParam(Integer id) {
        specParamMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
```

# 五，商品管理

## 1.centos下安装fastDFS

解压fastDFS压缩包.得到压缩文件

在linux系统中自己的目录下新建fastDFS目录

```
mkdir fastDFS
```

进入fastDFS目录

```
cd fastDFS/
```

将刚刚解压得到的压缩包全部上传到此文件内

**安装C/C++ 编译环境**

```
yum -y install gcc gcc-c++ autoconf pcre pcre-devel make automake
```

**安装libevent**

```
yum -y install libevent
```

**安装 libfastcommon**

```
tar -xvf libfastcommon-master.tar #解压压缩包
cd libfastcommon-master/ #进入目录
./make.sh #编译
```

```
./make.sh install #安装
cp /usr/lib64/libfastcommon.so /usr/lib #复制镜像
```

**安装FastDFS**

```
cd .. #进入fastDFS目录
tar -zxvf FastDFS_v5.08.tar.gz #解压压缩包
cd FastDFS/ #进入目录
./make.sh #编译
./make.sh install #安装
```

**启动tracker**

```
cd /etc/fdfs #进入fastDFS配置目录
cp tracker.conf.sample tracker.conf #复制文件
vi tracker.conf #编辑刚刚复制的配置文件
```

**修改配置**

```
base_path=/shop/fdfs/tracker
```

**保存并退出文件 创建刚刚设置的目录**

```
mkdir -p /shop/fdfs/tracker
```

**启动tracker**

```
service fdfs_trackerd start #停止换成stop
```

**启动storage**

```
cp storage.conf.sample storage.conf
vi storage.conf
```

**修改配置**

```
base_path=/shop/fdfs/storage
store_path0=/shop/fdfs/storage
tracker_server=本机ip地址:22122 #注意不能写localhost,需要写ip地址
```

**保存并退出 创建刚刚设置的目录**

```
mkdir -p /shop/fdfs/storage
```

启动storage

```
service fdfs_storaged start
```

查看进程

```
ps -ef | grep fdf
```

#### 安装FastDFS的Nginx模块

进入压缩包所在的目录

```
tar -zxvf fastdfs-nginx-module_v1.16.tar.gz #解压压缩包
cd fastdfs-nginx-module/src/ #进入目录
vi config
//直接输入下面的命令,注意冒号需要手敲
: --> %s+/usr/local/+/usr/+g --> enter --> esc --> :wq --> enter
```

保存并退出

```
cp mod_fastdfs.conf /etc/fdfs/ #复制文件
vi /etc/fdfs/mod_fastdfs.conf
```

修改默认配置

```
connect_timeout=10
tracker_server=本机ip地址:22122 #不能写localhost
url_have_group_name = true
store_path0=/shop/fdfs/storage
```

保存并退出 进入FastDFS/conf目录

```
cp http.conf mime.types /etc/fdfs/ #复制文件
```

#### 安装Nginx

进入压缩包所在的目录

```
tar -zxvf nginx-1.10.0.tar.gz #解压压缩包
yum -y install make zlib-devel libtool openssl openssl-devel #安装依赖
cd nginx-1.10.0/
./configure --prefix=/opt/nginx --sbin-path=/usr/bin/nginx --addmodule=/jlz/fastDFS/fastdfs-nginx-module/src
```

注意: 

--prefix= --> nginx配置文件所在目录

 --sbin-path= --> 执行程序文件所在目录 

--add-module= -->外部模块路径，启用对外部模块的支持 这个路径一定不能配置错,就写你自己 fastdfs-nginx-module的目录即可

```
make && make install #编译并安装
```

编辑nginx的配置文件

```
vi /opt/nginx/conf/nginx.conf
```

server的配置

```
listen 80;
server_name localhost:8888;#storage的端口号
# 监听域名中带有group的，交给FastDFS模块处理
location ~/group([0-9])/ {
ngx_fastdfs_module;
}
```

保存并退出

```
cd /opt/nginx #nginx主目录
```

启动nginx

```
nginx
nginx -s stop #停止
nginx -s reload #重新加载配置
```

浏览器输入ip地址访问

成功！！！！

## 2.java上传文件到fastDFS服务

mingrui-shop-basics: mingrui-shop-basic-upload-server

pom.xml

```
<!--        fastDFS服务-->
        <dependency>
            <groupId>com.github.tobato</groupId>
            <artifactId>fastdfs-client</artifactId>
            <version>1.26.1-RELEASE</version>
        </dependency>
```

application.yml

```
fdfs:
  so-timeout: 1501
  connect-timeout: 601
  thumb-image: # 缩略图
    width: 60
    height: 60
  tracker-list: # tracker地址
    - 119.45.210.115:22122
mingrui:
  upload:
    path:
      windows: D:\\images
      linux: /zhengzhebo/images
    img:
      host: http://119.45.210.115/
```

新建config包下新建配置类FastClientImporter

```
import com.github.tobato.fastdfs.FdfsClientConfig;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableMBeanExport;
import org.springframework.context.annotation.Import;
import org.springframework.jmx.support.RegistrationPolicy;

@Configuration
@Import(FdfsClientConfig.class)
// 解决jmx重复注册bean的问题
@EnableMBeanExport(registration = RegistrationPolicy.IGNORE_EXISTING)
public class FastClientImporter {
}
```

新建FastDFSUploadController上传文件controller

```
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.github.tobato.fastdfs.domain.StorePath;
import com.github.tobato.fastdfs.domain.ThumbImageConfig;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;
@RestController
@RequestMapping(value = "upload")
@Slf4j
public class FastDFSUploadController {
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;

    // 负责存储图片的客户端
    @Autowired
    private FastFileStorageClient storageClient;

    //缩略图配置
    @Autowired
    private ThumbImageConfig thumbImageConfig;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) throws IOException {

        InputStream inputStream = file.getInputStream();//获取文件输入流(二进制字节流)
        String filename = file.getOriginalFilename();//文件名
        //1.aa.jpg substring 要头不要尾
        String ex = filename.substring(filename.lastIndexOf(".") + 1);//文件后缀名
        // 上传并且生成缩略图
        StorePath storePath = this.storageClient.uploadImageAndCrtThumbImage(
                inputStream, file.getSize(), ex, null);//上传
        // 带分组的路径
        log.info("上传图片全路径:{}", storePath.getFullPath());
        // 不带分组的路径
        log.info("上传图片路径:{}", storePath.getPath());
        // 获取缩略图路径
        String path = thumbImageConfig.getThumbImagePath(storePath.getFullPath());
        log.info("缩略图路径:{}", path);

        return new Result<String>(HTTPStatus.OK,"上传成功",imgHost + path);
    }

}
```

将UploadController中所有注释注掉或删除UploadController

postman测试

浏览器输入http://119.45.210.115/group1/M00/00/00/Cs4ADV_0fGGATilgAAIUzJRKgKA734_60x60.jpg

出现图片成功！！

## 3.商品管理(查询)

Goods.vue

line：203

```
 getDataFromApi() {
        this.loading = true;
        //第三个参数可以设置axios参数
        //timeout:设置超时时间
        this.$http.get('goods/getSpuInfo',{
        //分页
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            //上下架
            order: this.pagination.descending,
            //条件查询
            saleable:this.search.saleable,
            title:this.search.key
          }
        }).then((resp)=>{
            this.items = resp.data.data.list;
            this.totalItems = resp.data.data.total;
            this.loading = false;
        }).catch(error => console.log(error))
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
```

line:8

```
 <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
        </v-btn-toggle>
```





mingrui-shop-service-api-xxx

com.baidu.shop.entity：新建 SpuEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Table(name = "tb_spu")
@Data
public class SpuEntity {
    @Id
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;
}
```

com.baidu.shop.dto：新建SpuDto

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;
import java.util.Date;

@ApiModel(value = "spu传输DTO")
@Data
public class SpuDto extends BaseDTO {
    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotNull(message = "标题不能为空",groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    @NotNull(message = "子标题不能为空",groups = {MingruiOperation.Add.class})
    private String subTitle;

    @ApiModelProperty(value = "1级类录id",example = "1")
    @NotNull(message = "1级类录id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类录id",example = "1")
    @NotNull(message = "2级类录id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类录id",example = "1")
    @NotNull(message = "3级类录id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id",example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架",example = "1")
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效",example = "1")
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;
}
```

om.baidu.shop.service：新建GoodsService

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDto;
import com.baidu.shop.entity.SpuEntity;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Api(tags = "商品接口")
public interface GoodsService {
    @ApiOperation(value = "查询商品信息")
    @GetMapping(value = "goods/getSpuInfo")
    Result<PageInfo<SpuEntity>> getSpuInfo(SpuDto spuDto);
}
```

mingrui-shop-service-xxx

com.baidu.shop.mapper:新建SpuMapper



```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuMapper extends Mapper<SpuEntity> {
}
```

修改 CategoryMapper

```
import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.SelectByIdListMapper; 
import tk.mybatis.mapper.common.Mapper;
import java.util.List;

public interface CategoryMapper extends Mapper<CategoryEntity>,
SelectByIdListMapper<CategoryEntity,Integer> {
@Select(value = "select c.id,c.name from tb_category c where c.id in(select
t.category_id from tb_category_brand t where t.brand_id=#{brandId})")
List<CategoryEntity> getCatesByBrand(Integer brandId); 
}
```



com.baidu.shop.service.impl 新建GoodsServiceImpl

```
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDto;
import com.baidu.shop.entity.SpuEntity;
import com.baidu.shop.mapper.SpuMapper;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.aspectj.weaver.ast.Var;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.List;
@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {

    @Resource
    private SpuMapper spuMapper;

    @Override
    public Result<PageInfo<SpuEntity>> getSpuInfo(SpuDto spuDto) {
        //分页插件
        if (ObjectUtil.isNotNull(spuDto.getPage()) && ObjectUtil.isNotNull(spuDto.getRows()))
            PageHelper.startPage(spuDto.getPage(),spuDto.getRows());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();

        //上下架
        if (ObjectUtil.isNotNull(spuDto.getSaleable()) && spuDto.getSaleable() < 2)
            criteria.andEqualTo("saleable",spuDto.getSaleable());
        //条件查询
        if(!StringUtils.isEmpty(spuDto.getTitle()))
            criteria.andLike("title","%"+spuDto.getTitle()+"%");

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);
        //分页
        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);

        return this.setResultSuccess(spuEntityPageInfo);
    }
}
```

## 4.商品管理(新增)

vue

1.GoodsFrom.vue

line:20

```
<!--商品分类-->
<v-cascader
url="/category/list"
required
showAllLevels
v-model="goods.categories"
label="请选择商品分类"/>
```

line:277

```
handler(val) {
// 判断商品分类是否存在，存在才查询
if (val && val.length > 0) {
// 根据分类查询品牌
this.$http
.get("/brand/getBrandByCategory",{
params:{
cid:this.goods.categories[2].id
}
})
.then((resp) => {
this.brandOptions = resp.data.data;
});
// 根据分类查询规格参数
this.$http
.get("/specparam/getSpecParamInfo",{
params:{
cid:this.goods.categories[2].id
}
})
.then(( resp ) => {
let specs = [];
let template = [];
if (this.isEdit){
specs = JSON.parse(this.goods.spuDetail.genericSpec);
template = JSON.parse(this.goods.spuDetail.specialSpec);
}
// 对特有规格进行筛选
const arr1 = [];
const arr2 = [];
resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
if(generic){
const o = { id, name, numeric, unit};
if(this.isEdit){
o.v = specs[id];
}
arr1.push(o)
}else{
const o = {id, name, options:[]};
if(this.isEdit){
o.options = template[id];
}
arr2.push(o)
}
});
this.specs = arr1;// 通用规格
this.specialSpecs = arr2;// 特有规格
});
}
}

```

line:57

```
<v-stepper-content step="2">
<v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
</v-stepper-content>
```

line:206

```
images: images ? images.map(i => i.data).join(",") : '', // 图片
```

2.Editor.vue

line:93

```
this.$http.post(this.uploadUrl, data)
.then(resp => {
//修改图片回显的路径
if (resp.data.data) {
this.editor.insertEmbed(this.editor.getSelection().index, 'image',
resp.data.data)
}
})
```

3.mingrui-shop-service-api-xxx

BrandService

```
  @GetMapping(value = "brand/getBrandInfoByCategoryId")
    @ApiOperation(value = "通过分类id查询品牌")
    Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid);
```

mingrui-shop-service-xxx

BrandMapper

```

package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface BrandMapper extends Mapper<BrandEntity> {

    @Select(value = "select * from tb_brand b where b.id in(select cb.brand_id from tb_category_brand cb where cb.category_id=#{cid})")
    List<BrandEntity> getBrandInfoByCategoryId(Integer cid);
}
```

BrandServiceImpl

```
 @Override
    public Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid) {

        List<BrandEntity> list = brandMapper.getBrandInfoByCategoryId(cid);

        return this.setResultSuccess(list);
    }
```

SpecificationServiceImpl

```
@Override
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {

        SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);
        Example example = new Example(SpecParamEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if(ObjectUtil.isNotNull(specParamEntity.getGroupId()))
            criteria.andEqualTo("groupId",specParamEntity.getGroupId());
        if(ObjectUtil.isNotNull(specParamEntity.getCid()))
            criteria.andEqualTo("cid",specParamEntity.getCid());

        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);

        return this.setResultSuccess(specParamEntities);
    }

```

##  5.商品管理(新增[传值接值])

1.mingrui-shop-service-api-xxx

 1.1entity包下实体类

 SpuDetailEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName SpuDetailEntity
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2021/1/7
 * @Version V1.0
 **/
@Table(name = "tb_spu_detail")
@Data
public class SpuDetailEntity {

    @Id
    private Integer spuId;

    private String description;

    private String genericSpec;

    private String specialSpec;

    private String packingList;

    private String afterService;
}

```

SkuEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * @ClassName SkuEntity
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2021/1/7
 * @Version V1.0
 **/
@Table(name = "tb_sku")
@Data
public class SkuEntity {

    @Id//此处必须写long类型,因为现在新增的id已经超过int的范围了
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private String indexes;

    private String ownSpec;

    private Integer enable;

    private Date createTime;

    private Date lastUpdateTime;
}

```

StockEntity

```
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName StockEntity
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2021/1/7
 * @Version V1.0
 **/
@Table(name = "tb_stock")
@Data
public class StockEntity {

    @Id
    private Long skuId;

    private Integer seckillStock;

    private Integer seckillTotal;

    private Integer stock;
}

```

1.2dto包下新建dto

 SpuDetailDTO

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName SpuDetailDTO
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2021/1/7
 * @Version V1.0
 **/
@ApiModel(value = "spu大字段数据传输类")
@Data
public class SpuDetailDTO {

    @ApiModelProperty(value = "spu主键",example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品描述信息")
    private String description;

    @ApiModelProperty(value = "通用规格参数数据")
    private String genericSpec;

    @ApiModelProperty(value = "特有规格参数及可选值信息，json格式")
    private String specialSpec;

    @ApiModelProperty(value = "包装清单")
    private String packingList;

    @ApiModelProperty(value = "售后服务")
    private String afterService;
}

```

SkuDTO

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.util.Date;

/**
 * @ClassName SkuDTO
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2021/1/7
 * @Version V1.0
 **/
@ApiModel(value = "SKU属性数据传输类")
@Data
public class SkuDTO {

    @ApiModelProperty(value = "主键", example = "1")
    private Long id;

    @ApiModelProperty(value = "spu主键", example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品标题")
    private String title;

    @ApiModelProperty(value = "商品的图片，多个图片以‘,’分割")
    private String images;

    @ApiModelProperty(value = "销售价格，单位为分", example = "1")
    private Integer price;

    @ApiModelProperty(value = "特有规格属性在spu属性模板中的对应下标组合")
    private String indexes;

    @ApiModelProperty(value = "sku的特有规格参数键值对，json格式，反序列化时请使用linkedHashMap，保证有序")
    private String ownSpec;

    //注意此处使用boolean值来接,在service中处理一下就可以了
    @ApiModelProperty(value = "是否有效，0无效，1有效", example = "1")
    private Boolean enable;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    //方便接受页面传递过来的参数
    @ApiModelProperty(value = "库存")
    private Integer stock;
}

```

StockDTO

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName StockDTO
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2021/1/7
 * @Version V1.0
 **/
@ApiModel(value = "库存数据传输类")
@Data
public class StockDTO {

    @ApiModelProperty(value = "sku主键", example = "1")
    private Long skuId;

    @ApiModelProperty(value = "可秒杀库存", example = "1")
    private Integer seckillStock;

    @ApiModelProperty(value = "秒杀总数量", example = "1")
    private Integer seckillTotal;

    @ApiModelProperty(value = "库存数量", example = "1")
    private Integer stock;
}

```

修改SpuDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

/**
 * @ClassName SpuDTO
 * @Description: TODO
 * @Author zhengzhenbo
 * @Date 2021/1/5
 * @Version V1.0
 **/
@ApiModel(value = "spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键", example = "1")
    @NotNull(message = "主键不能为空", groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空", groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id", example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id", example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id", example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id", example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架", example = "1")
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效", example = "1")
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    private String categoryName;

    private String brandName;

    @ApiModelProperty(value = "大字段数据")
    private SpuDetailDTO spuDetail;

    @ApiModelProperty(value = "sku属性数据集合")
    private List<SkuDTO> skus;
}

```

2.GoodsService

```
  @ApiOperation(value = "新增商品")
  @PostMapping(value = "/goods/save")
  Result<JSONObject> saveGoods(@RequestBody SpuDTO spuDTO);
```

3.GoodsServiceImpl

```
@Override
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
System.out.println(spuDTO);
return this.setResultSuccess();
}
```

## 6.商品管理(新增[入库])

vue

1.GoodsForm.vue line:277

```
this.$emit("closeForm");//bug......
```

2.mingrui-shop-service-xxx

 mapper包下新建mapper

 SpuDetailMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuDetailEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuDetailMapper extends Mapper<SpuDetailEntity> {
}

```

 SkuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;

import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity> , DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")

    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}

```

 StockMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

public interface StockMapper extends Mapper<StockEntity>, DeleteByIdListMapper<StockEntity,Long> {
}

```

GoodsServiceImpl

```
@Resource
private CategoryMapper categoryMapper;
@Resource
private SpuDetailMapper spuDetailMapper;
@Resource
private SkuMapper skuMapper;
@Resource
private StockMapper stockMapper;

 @Override
    @Transactional
    public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
        //final finally finalize()的区别????
        final Date date = new Date();
        //新增spu,新增返回主键, 给必要字段赋默认值
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setSaleable(1);
        spuEntity.setValid(1);
        spuEntity.setCreateTime(date);
        spuEntity.setLastUpdateTime(date);
        spuMapper.insertSelective(spuEntity);

        //新增spuDetail
        SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
        SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
        spuDetailEntity.setSpuId(spuEntity.getId());
        spuDetailMapper.insertSelective(spuDetailEntity);

        //新增sku list插入顺序有序
        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {

            SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuEntity.getId());
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            //新增stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });

        return this.setResultSuccess();
    }

```

##  7.商品管理修改(回显数据)

 vue项目

```
注意:源码中bug太多.....
将editItem函数中的内容全部删除掉
editItem函数中需要将spuDetail和skus全部查询出来再赋值给this.selectedGoods赋值
demo中的回显只能回显spu的相关信息
spuDetail和sku stock需要我们自己从数据库中查询
```

1.Goods.vue

```
editItem(item) {
//弹出模态框,页面bug,理论上不应该这么做
this.isEdit = true;
this.show = true;
//不能直接给this.selectedGoods赋值,在这赋值以后GoodsForm会监控到oldGoods发生变化
了
// this.selectedGoods = item;
// const names = item.categoryName.split("/");
// this.selectedGoods.categories = [
// { id: item.cid1, name: names[0] },
// { id: item.cid2, name: names[1] },
// { id: item.cid3, name: names[2] },
// ];
//列表中传输过来的数据
let obj = item;
// 查询商品详情
this.$http
.get("/goods/getSpuDetailBydSpu", {
params: {
spuId: item.id,
},
})
.then((resp) => {
//准备分类需要回显的数据
obj.categories = [];//解决子级组件监控undefiend问题
//商品详情
obj.spuDetail = resp.data.data;
//特殊规格数据
obj.spuDetail.specTemplate = resp.data.specialSpec;
//通用规格数据
obj.spuDetail.specifications = resp.data.genericSpec;
//查询sku
this.$http
.get("goods/getSkuBySpuId", {
params: {
spuId: item.id,
},
})
.then((resp) => {
obj.skus = resp.data.data;
//需要回显的数据
this.selectedGoods = obj;//最后再给selectedGoods赋值
})
.catch((error) => console.log(error));
});
},
```

2.GoodsForm.vue

```
//监控需要回显的数据
oldGoods: {
deep: true,
handler(val) {
//新增,清空数据
if (!this.isEdit) {
Object.assign(this.goods, {
categories: null, // 商品分类信息
brandId: 0, // 品牌id信息
title: "", // 标题
subTitle: "", // 子标题
spuDetail: {
packingList: "", // 包装列表
afterService: "", // 售后服务
description: "" // 商品描述
}
});
this.specs = [];
this.specialSpecs = [];
} else {//修改
//深拷贝?????深拷贝与浅拷贝的区别
this.goods = Object.deepCopy(val);
// 先得到分类名称 bug我们获取到的是categoryName
const names = val.categoryName.split("/");
// 组织商品分类数据
setTimeout(() => {
this.goods.categories = [
{ id: val.cid1, name: names[0] },
{ id: val.cid2, name: names[1] },
{ id: val.cid3, name: names[2] }
];
},100);
// 将skus处理成map
const skuMap = new Map();
this.goods.skus.forEach(s => {
skuMap.set(s.indexes, s);
});
this.goods.skus = skuMap;
}
}
},
"goods.categories": {
deep: true,
handler(val) {
// 判断商品分类是否存在，存在才查询
if (val && val.length > 0) {
// 根据分类查询品牌
this.$http
.get("brand/getBrandByCategory",{
params:{
cid:this.goods.categories[2].id
}
})
.then((resp) => {
this.brandOptions = resp.data.data;
});
// 根据分类查询规格参数
this.$http
.get("/specparam/getSpecParamInfo",{
params:{
cid:this.goods.categories[2].id
}
})
.then(( resp ) => {
let specs = [];
let template = [];
if (this.isEdit){
specs = JSON.parse(this.goods.spuDetail.genericSpec);
template = JSON.parse(this.goods.spuDetail.specialSpec);
}
// 对特有规格进行筛选
const arr1 = [];
const arr2 = [];
resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
if(generic){
const o = { id, name, numeric, unit};
if(this.isEdit){
o.v = specs[id];
}
arr1.push(o)
}else{
const o = {id, name, options:[]};
if(this.isEdit){
o.options = template[id];
}
arr2.push(o)
}
});
this.specs = arr1;// 通用规格
this.specialSpecs = arr2;// 特有规格
});
}
}
}
},
```

3.mingrui-shop-service-api-xxx

GoodsService

```
    @ApiOperation(value = "通过spuId查询spudetail信息")
    @GetMapping(value = "/goods/getSpuDetailBySpuId")
    Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId);

    @ApiOperation(value = "通过spuId查询sku信息")
    @GetMapping(value = "/goods/getSkusBySpuId")
    Result<List<SkuDTO>> getSkusBySpuId(Integer spuId);
```

4.mingrui-shop-service-xxx

SkuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;

import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity> , DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")

    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}

```

GoodsServiceImpl

```
@Override
public Result<SpuDetailEntity> getSpuDetailBydSpu(Integer spuId) {
SpuDetailEntity spuDetailEntity =
spuDetailMapper.selectByPrimaryKey(spuId);
return this.setResultSuccess(spuDetailEntity);
}
@Override
public Result<List<SkuDTO>> getSkuBySpuId(Integer spuId) {
List<SkuDTO> list = skuMapper.selectSkuAndStockBySpuId(spuId);
return this.setResultSuccess(list);
}

```

## 8.修改(后台)

vue项目

1.GoodsForm.vue

```
this.$http({
method: this.isEdit ? "put" : "post",
url: "/goods/save",
data: goodsParams
})

```

2.mingrui-shop-service-api-xxx

```
@ApiOperation(value = "新建商品")
@PostMapping(value = "goods/save")
Result<JSONObject> saveGoods(@RequestBody SpuDTO spuDTO);
@ApiOperation(value = "修改商品")
@PutMapping(value = "goods/save")
Result<JSONObject> editGoods(@RequestBody SpuDTO spuDTO);
```

3.mingrui-shop-service-xxx

 修改的步骤

```
1. 修改spu
2. 修改spuDetail
3. 通过spuId查询出来将要被删除的sku
4. 获取所有将要被删除skuId(如果直接删除的话stock没有办法删除)
5. 批量删除sku
6. 批量删除stock
7. 将新的数据新增到数据库
```

4.修改SkuMapper和StockMapper

SkuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;

import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity> , DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")

    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}

```

StockMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

public interface StockMapper extends Mapper<StockEntity>, DeleteByIdListMapper<StockEntity,Long> {
}

```

GoodsServiceImpl

```
 @Override
    @Transactional
    public Result<JSONObject> editGoods(SpuDTO spuDTO) {

        final Date date = new Date();
        //修改spu
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setLastUpdateTime(date);
        spuMapper.updateByPrimaryKeySelective(spuEntity);

        //修改spuDetail
        spuDetailMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(),SpuDetailEntity.class));

        //通过spuId查询sku信息
        this.deleteSkusAndStock(spuEntity.getId());

        this.saveSkusAndStockInfo(spuDTO,spuEntity.getId(),date);

        return this.setResultSuccess();
    }





    private void saveSkusAndStockInfo(SpuDTO spuDTO,Integer spuId,Date date){

        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {

            SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuId);
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            //新增stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });
    }
```

## 9.删除

vue项目

1. Goods.vue

```
deleteItem(id) {
this.$message
.confirm("此操作将永久删除该商品, 是否继续?")
.then(() => {
// 发起删除请求
this.$http.delete("goods/del?spuId=" + id).then(() => {
// 删除成功，重新加载数据
this.getDataFromApi();
this.$message.info("删除成功!");
});
})
.catch(() => {
this.$message.info("已取消删除");
});
},
```

2.mingrui-shop-service-api-xxx

GoodsService

```
 @ApiOperation(value = "删除商品")
    @DeleteMapping(value = "/goods/delete")
    Result<JSONObject> deleteGoods(Integer spuId);

```

3.mingrui-shop-service-xxx

 GoodsServiceImpl

```
 @Override
    @Transactional
    public Result<JSONObject> deleteGoods(Integer spuId) {
        //删除spu
        spuMapper.deleteByPrimaryKey(spuId);
        //删除spuDetail
        spuDetailMapper.deleteByPrimaryKey(spuId);
        //删除sku 和 stock
        //通过spuId查询sku信息
        this.deleteSkusAndStock(spuId);

        return this.setResultSuccess();
    }

    private void deleteSkusAndStock(Integer spuId){
        Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuId);
        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        //得到skuId集合
        List<Long> skuIdList = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuIdList);//通过skuId集合删除sku信息
        stockMapper.deleteByIdList(skuIdList);//通过skuId集合删除stock信息
    }
```

